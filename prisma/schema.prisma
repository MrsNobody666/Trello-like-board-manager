// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}


model Workspace {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  createdById String?
  createdBy   Member?   @relation("WorkspaceCreator", fields: [createdById], references: [id])
  
  boards      Board[]
  members     WorkspaceMember[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
}

model Board {
  id          String   @id @default(uuid())
  title       String
  imageId     String   @default("default")
  imageThumbUrl String?  
  imageFullUrl String? 
  imageUserName String?
  imageLinkHTML String?
  
  description String?
  visibility  String   @default("WORKSPACE") // "PRIVATE", "WORKSPACE", "PUBLIC"
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  lists       List[]
  labels      Label[]
  automationRules AutomationRule[]
  customFields  CustomField[]
  activities    Activity[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
}

model List {
  id        String   @id @default(uuid())
  title     String
  position  Int      // Renamed from order
  
  boardId   String
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  
  cards     Card[]
  
  isArchived Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([boardId])
}

model Card {
  id          String   @id @default(uuid())
  title       String
  description String?
  position    Int      // Renamed from order
  coverImage  String?  // URL or color for card cover
  
  listId      String
  list        List     @relation(fields: [listId], references: [id], onDelete: Cascade)
  
  isArchived  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([listId])

  labels      CardLabel[]
  members     CardMember[]
  checklists  Checklist[]
  attachments Attachment[]
  customFields CustomFieldValue[]
  comments    Comment[]
  activities  Activity[]
  dueDate     DateTime?
}

model Member {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  avatarUrl String?
  
  workspaces       WorkspaceMember[]
  createdWorkspaces Workspace[]       @relation("WorkspaceCreator")
  cards            CardMember[]
  activities       Activity[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkspaceMember {
  workspaceId String
  memberId    String
  role        String   @default("NORMAL") // "ADMIN", "NORMAL"
  
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  member      Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@id([workspaceId, memberId])
  @@index([workspaceId])
  @@index([memberId])
}

model CardMember {
  cardId   String
  memberId String
  role     String   @default("NORMAL") // "ADMIN", "NORMAL", "OBSERVER"
  
  card     Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@id([cardId, memberId])
  @@index([cardId])
  @@index([memberId])
}

model Attachment {
  id        String   @id @default(uuid())
  name      String
  url       String
  type      String   // "image", "pdf", "link", etc.
  size      Int?     // in bytes
  
  cardId    String
  card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([cardId])
}

model Label {
  id        String      @id @default(uuid())
  title     String
  color     String
  boardId   String
  board     Board       @relation(fields: [boardId], references: [id], onDelete: Cascade)
  
  cards     CardLabel[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([boardId])
}

model CardLabel {
  cardId    String
  labelId   String
  
  card      Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)
  label     Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([cardId, labelId])
  @@index([cardId])
  @@index([labelId])
}

model Checklist {
  id        String          @id @default(uuid())
  title     String
  
  cardId    String
  card      Card            @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  items     ChecklistItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([cardId])
}

model ChecklistItem {
  id          String    @id @default(uuid())
  title       String
  isChecked   Boolean   @default(false)
  dueDate     DateTime?
  
  checklistId String
  checklist   Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([checklistId])
}

model AutomationRule {
    id          String   @id @default(uuid())
    boardId     String
    board       Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
    
    name        String
    enabled     Boolean  @default(true)
    
    // Trigger & Conditions
    triggerType String   // "card_created", "card_moved", "due_date_reached", "label_added", etc.
    conditions  String?  // JSON string for conditional logic (e.g., "if in list X", "if has label Y")
    
    // Actions
    actions     String   // JSON string of actions array ([{type: '...', data: {...}}])
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@index([boardId])
}

model AutomationLog {
    id          String   @id @default(uuid())
    ruleId      String
    cardId      String?
    
    status      String   // "success", "error"
    message     String?
    
    executedAt  DateTime @default(now())
    
    @@index([ruleId])
    @@index([cardId])
}
model CustomField {
  id          String   @id @default(uuid())
  name        String
  type        String   // "TEXT", "NUMBER", "DATE", "DROPDOWN"
  options     String?  // JSON string for dropdown options
  
  boardId     String
  board       Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  
  values      CustomFieldValue[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([boardId])
}

model CustomFieldValue {
  id          String   @id @default(uuid())
  value       String?
  
  cardId      String
  card        Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  fieldId     String
  field       CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([cardId])
  @@index([fieldId])
  @@unique([cardId, fieldId])
}

model Comment {
    id        String   @id @default(uuid())
    text      String
    
    cardId    String
    card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@index([cardId])
}

model Activity {
    id          String   @id @default(uuid())
    boardId     String?  // Optional for global or card-agnostic board actions
    userId      String
    action      String   // "CARD_MOVED", "COMMENT_ADDED", "CARD_CREATED", etc.
    entityType  String   // "CARD", "LIST", "LABEL", "BOARD"
    entityId    String   // UUID of the entity
    details     String?  // JSON string with additional details
    
    board       Board?    @relation(fields: [boardId], references: [id], onDelete: Cascade)
    user        Member   @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    // Legacy support for Card relations
    cardId      String?
    card        Card?     @relation(fields: [cardId], references: [id], onDelete: Cascade)
    
    createdAt DateTime @default(now())
    
    @@index([boardId])
    @@index([userId])
    @@index([cardId])
    @@index([createdAt])
}

model Integration {
  id          String   @id @default(uuid())
  name        String   // e.g., "Gmail", "GitHub"
  type        String   // "GMAIL", "GITHUB", "SLACK", "CALENDAR"
  enabled     Boolean  @default(false)
  accessToken String?
  refreshToken String?
  lastSyncedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ExternalItem {
  id          String   @id @default(uuid())
  externalId  String   @unique
  source      String   // "GMAIL", "GITHUB", etc.
  title       String
  description String?
  metadata    String?  // JSON string for source-specific data (e.g., event time)
  status      String   @default("PENDING") // "PENDING", "SYNCED", "IGNORED"
  
  cardId      String?  // If converted to a TaskMaster card
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([externalId])
}
